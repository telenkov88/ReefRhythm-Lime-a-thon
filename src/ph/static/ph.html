<!DOCTYPE html>
<html lang="en" data-bs-theme="dark">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>PH control</title>

    <script>
        function loadLocalScript(local_js) {
            console.log("Load local js ", local_js)
            var script = document.createElement('script');
            script.src = local_js; // URL to your local script
            document.head.appendChild(script);
        }


    </script>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"
            onerror="loadLocalScript('javascript/bootstrap.bundle.min.js')"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/3.7.0/chart.min.js"
            onerror="loadLocalScript('javascript/chart.min.js')"></script>


    <link rel="icon" type="image/x-icon" href="/favicon/favicon.ico">

    <style>
        header {
            display: flex;
            justify-content: space-between;
            padding: 10px;
            background-color: #f0f0f0;
        }

        header a {
            text-decoration: none;
            color: #333;
            padding: 5px 10px;
        }

        .container {
        }

        .form-row {
            display: flex;
            align-items: center;
            margin-bottom: 1px;
        }

        label, select, input, button {
            display: block;
            margin-bottom: 10px;
        }

        body {
        }


    </style>


</head>
<body>
<nav class="navbar navbar-expand-lg bg-primary" data-bs-theme="dark">
    <div class="container-fluid">
        <a class="navbar-brand" href="/">Dosing</a>
        <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarColor01"
                aria-controls="navbarColor01" aria-expanded="false" aria-label="Toggle navigation">
            <span class="navbar-toggler-icon"></span>
        </button>
        <div class="collapse navbar-collapse" id="navbarColor01">
            <ul class="navbar-nav me-auto">
                <li class="nav-item">
                    <a class="nav-link" href="/calibration">Calibration</a>
                </li>
                <li class="nav-item">
                    <a class="nav-link" href="/settings">Settings</a>
                </li>
                <li class="nav-item">
                    <a class="nav-link" href="/ota-upgrade">OTA</a>
                </li>
            </ul>
        </div>
    </div>
</nav>


<ul class="nav nav-tabs" role="tablist">
    <li class="nav-item" role="presentation">
        <a class="nav-link active" data-bs-toggle="tab" href="#calibrationtab" aria-selected="true" role="tab">PH
            Calibration</a>
    </li>
    <li class="nav-item" role="presentation">
        <a class="nav-link" data-bs-toggle="tab" href="#controltab" aria-selected="false" tabindex="-1" role="tab">Control</a>
    </li>
    <li class="nav-item" role="presentation">
        <a class="nav-link" data-bs-toggle="tab" href="#reagentstab" aria-selected="false" role="tab" tabindex="-1">PH
            reagents</a>
    </li>
</ul>

<div id="myTabContent" class="tab-content">
    <div class="tab-pane fade container active show" id="calibrationtab" role="tabpanel">
        <h2>PH Calibration</h2>
        <label for="calibrationReagents">Reagent:</label>
        <select class="form-select" id="calibrationReagents" style="width: 250px" onchange="checkCalReagent()">
        </select>


        <table class="table table-hover" style="width: 250px">
            <thead>
            <tr>
                <th scope="col">PH</th>
                <th scope="col">Volt</th>
                <th scope="col">Temp</th>
            </tr>
            </thead>
            <tbody>
            <tr class="table-active" style="height: 30px">
                <th scope="row" id="phTh" style="width: 70px"></th>
                <th scope="row" id="phAdcTh" style="width: 80px"></th>
                <th scope="row" id="tempTh"></th>
            </tr>
            </tbody>
        </table>
        <button type="button" id="addCalBtn" onclick="addCalPoint()" class="btn btn-primary">Add calibration
            point
        </button>
        <button type="button" onclick="uploadPHCalibtaionPoints()" class="btn btn-success">Apply</button>
        <table class="table table-hover" style="width: 250px">
            <thead>
            <tr>
                <th scope="col">Reagent</th>
                <th scope="col">PH</th>
                <th scope="col">Volt</th>
                <th scope="col">Temp</th>
            </tr>

            </thead>
            <tbody id="phCalTableBody">
            </tbody>
        </table>

        <div id="chart-container" style="width: 98%; aspect-ratio : 2 / 1;border:1px solid red; align-content: center ">
            <canvas id="calibrationChart" style="width: 100%;"></canvas>
        </div>


    </div>


    <div class="tab-pane fade container" id="controltab">
    </div>

    <div class="tab-pane fade container" id="reagentstab">
        <h2>PH Reagents base</h2>
        <select class="form-select" id="ReagentsBase" style="width: 200px" onchange="updateTable()">
            <option value="PH 4.0@25C">PH 4.0@25C</option>
            <option value="PH 6.86@25C">PH 6.86@25C</option>
            <option value="PH 7.00@25C">PH 7.00@25C</option>
            <option value="PH 9.18@25C">PH 9.18@25C</option>
            <option value="PH 10.01@25C">PH 10.01@25C</option>
        </select>
        <div class="has-danger">
            <input type="text" id="newReagentName" oninput="checkReagentName()" class="form-control is-invalid"
                   placeholder="Enter new reagent name">
            <button id="addReagentBtn" onclick="addReagent()" class="btn btn-primary disabled">Add Reagent</button>
        </div>
        <button onclick="saveTable()" id="saveTableBtn" class="btn btn-primary disabled">Save Changes</button>

        <table id="phTable" class="table table-hover">
            <thead>
            <tr class="table-secondary">
                <th scope="row">Temperature</th>
                <th>PH</th>
            </tr>
            </thead>
            <tbody class="table-dark">
            <!-- Rows will be dynamically inserted here -->
            </tbody>
        </table>
    </div>


</div>


<script>
    let first_start = true
    let sse_ph = 0.0
    let sse_ph_adc = 0.0
    let sse_temp = 0.0
    let sse_tds_adc = 0.0
    let ph_chart_points = {"PhChartPoints ": []}

    let phCalPoints = {}

    const buildInReagents = [
        "PH 4.0@25C", "PH 7.00@25C", "PH 6.86@25C", "PH 7.00@25C", "PH 9.18@25C", "PH 10.01@25C"
    ]
    const pHData = {
        "PH 4.0@25C": [
            [10, 4.00], [15, 4.00], [20, 4.00], [25, 4.01], [30, 4.02], [35, 4.03], [40, 4.04], [45, 4.04], [50, 4.06]
        ],
        "PH 6.86@25C": [
            [10, 6.92], [15, 6.90], [20, 6.88], [25, 6.86], [30, 6.85], [35, 6.84], [40, 6.84], [45, 6.83], [50, 6.83]
        ],
        "PH 7.00@25C": [
            [10, 7.06], [15, 7.04], [20, 7.03], [25, 7.00], [30, 6.99], [35, 6.98], [40, 6.97], [45, 6.97], [50, 6.97]
        ],
        "PH 9.18@25C": [
            [10, 9.33], [15, 9.28], [20, 9.23], [25, 9.18], [30, 9.14], [35, 9.10], [40, 9.07], [45, 9.04], [50, 9.02]
        ],
        "PH 10.01@25C": [
            [10, 10.18], [15, 10.12], [20, 10.06], [25, 10.01], [30, 9.98], [35, 9.97], [40, 9.91], [45, 9.85], [50, 9.83]
        ]
    };

    function switchColor(color) {
        let color_mod
        if (color === 'auto') {
            const prefersDarkScheme = window.matchMedia("(prefers-color-scheme: dark)");
            if (prefersDarkScheme.matches) {
                color_mod = "dark"
            } else {
                color_mod = "light"
            }
        } else {
            color_mod = color
        }
        document.documentElement.setAttribute('data-bs-theme', color_mod)
    }

    function loadCdnCSS(cdn_css, fallback_css) {
        // Remove existing stylesheet if it exists
        var existingLink = document.querySelector("link[rel='stylesheet']");
        if (existingLink) {
            document.head.removeChild(existingLink);
        }

        // Create new link for the new CSS
        var link = document.createElement('link');
        link.rel = 'stylesheet';
        link.href = cdn_css;
        link.onerror = function () {
            console.error("Failed to load CDN CSS. Loading fallback.");
            loadLocalCSS(fallback_css);
        };
        document.head.appendChild(link);
    }

    function loadLocalCSS(local_css) {
        console.log("Loading local CSS: ", local_css)
        var link = document.createElement('link');
        link.rel = 'stylesheet';
        link.href = local_css;
        document.head.appendChild(link);
    }

    function switchTheme(theme) {
        loadCdnCSS('https://cdn.jsdelivr.net/npm/bootswatch@5.3.3/dist/' + theme + '/bootstrap.min.css', 'styles/' + theme + 'bootstrap.min.css');
    }




    let phCalPointsSSE = new EventSource("/ph-sse");
    let phChartPointsSSE = new EventSource("/ph-chart-sse");
    phCalPointsSSE.onopen = function (event) {
        console.log("SSE connection to server opened.");
    };
    phChartPointsSSE.onopen = function (event) {
        console.log("SSE connection to server opened.");
    };

    phCalPointsSSE.onerror = function (event) {
        if (event.currentTarget.readyState === EventSource.CLOSED) {
            console.log("SSE connection was closed.");
        } else {
            console.log("SSE Error occurred: ", event);
        }
    };
    phChartPointsSSE.onerror = function (event) {
        if (event.currentTarget.readyState === EventSource.CLOSED) {
            console.log("SSE connection was closed.");
        } else {
            console.log("SSE Error occurred: ", event);
        }
    };

    phCalPointsSSE.onmessage = function (event) {
        console.log("got sse data", event.data)
        const data = JSON.parse(event.data);
        //console.log("got sse data: ", data)
        sse_ph = Number(data["ph"])
        sse_ph_adc = Number(data["ph_adc"])
        sse_temp = Number(data["temp"])
        sse_tds_adc = Number(data["tds_adc"])


        document.getElementById("phTh").textContent = sse_ph.toFixed(2)
        document.getElementById("phAdcTh").textContent = sse_ph_adc.toFixed(3) + 'V'
        document.getElementById("tempTh").textContent = sse_temp.toFixed(1) + 'C'

    }


    // A function to extract value as an array and compare them
    function equalsCheck(a, b) {
        console.log("1:", a)
        console.log("2:", b)
        // check the length
        if (a.length !== b.length) {
            return false;
        } else {
            let result = false;

            // comparing each element of array
            for (let i = 0; i < a.length; i++) {

                if (a[i] !== b[i]) {
                    return false;
                } else {
                    result = true;
                }
            }
            return result;
        }
    }


    phChartPointsSSE.onmessage = function (event) {
        const data = JSON.parse(event.data);
        console.log("Got sse Chart points", data)

        if (first_start){
            ph_chart_points = data
            updatePHChart()
            first_start = false
        } else {
            console.log(data)
            if (!equalsCheck(ph_chart_points, data)) {
                console.log("skip chart update")
            } else {
                ph_chart_points = data
                updatePHChart()
            }
        }

    }


    function updateTable() {
        const select = document.getElementById("ReagentsBase");
        const selectedValue = select.value;
        const data = pHData[selectedValue];
        const tbody = document.getElementById("phTable").getElementsByTagName("tbody")[0];

        tbody.innerHTML = ""; // Clear existing rows
        document.getElementById("saveTableBtn").classList.add("disabled")

        data.forEach(([temp, ph]) => {
            const row = tbody.insertRow();
            row.insertCell(0).innerHTML = `${temp}`;
            if (buildInReagents.includes(selectedValue)) {
                // Protected Build In reagent
                row.insertCell(1).innerHTML = ph.toFixed(2);
            } else
                row.insertCell(1).innerHTML = `<input oninput="checkPHTable()" type="number" value="${ph.toFixed(2)}">`;
        });

        for (let i = 0; i < select.options.length; i++) {
            const optionValue = select.options[i].value;
            if (!(optionValue in pHData)) {
                console.log("remove empy table", optionValue)
                select.options[i].remove()
            }
        }
    }

    function checkPHTable() {
        const table = document.getElementById("phTable");
        const rows = table.getElementsByTagName("tbody")[0].rows;

        for (let i = 0; i < rows.length; i++) {
            const inputs = rows[i].getElementsByTagName("input");
            const ph = parseFloat(inputs[0].value); // PH input
            if (ph <= 0.001 || ph > 14 || !ph) {
                document.getElementById("saveTableBtn").classList.add("disabled")
                return
            }

        }
        document.getElementById("saveTableBtn").classList.remove("disabled")

    }

    function checkReagentName() {
        const reagentInput = document.getElementById("newReagentName");
        const newReagent = reagentInput.value;
        console.log("new reagent name: ", newReagent)
        console.log(!pHData.hasOwnProperty(newReagent))

        if (newReagent.trim() === "" || pHData.hasOwnProperty(newReagent)) {
            console.log("Invalid reagent name")
            document.getElementById("addReagentBtn").classList.add("disabled")
            reagentInput.classList.remove("is-valid")
            reagentInput.classList.add("is-invalid")
        } else {
            console.log("Valid reagent name")
            document.getElementById("addReagentBtn").classList.remove("disabled")
            reagentInput.classList.remove("is-invalid")
            reagentInput.classList.add("is-valid")
        }
    }

    function addReagent() {
        const reagentInput = document.getElementById("newReagentName");
        const newReagent = reagentInput.value;
        const selectReagentBase = document.getElementById("ReagentsBase");
        const selectCalibration = document.getElementById("calibrationReagents");

        const option = new Option(newReagent, newReagent);
        selectReagentBase.appendChild(option);
        selectCalibration.appendChild(option);
        reagentInput.value = ""; // Clear input after adding
        document.getElementById("ReagentsBase").value = newReagent
        document.getElementById("saveTableBtn").classList.add("disabled")
        //updateTable()
        const tbody = document.getElementById("phTable").getElementsByTagName("tbody")[0];
        tbody.innerHTML = ""; // Clear existing rows
        const empy_data = [10, 15, 20, 25, 30, 35, 40, 45, 50]
        empy_data.forEach((temp) => {
            const row = tbody.insertRow();
            row.insertCell(0).innerHTML = `${temp}`;
            row.insertCell(1).innerHTML = `<input oninput="checkPHTable()" type="number" value={null}">`;
        });
        checkReagentName()
    }

    function saveTable() {
        const table = document.getElementById("phTable");
        const rows = table.getElementsByTagName("tbody")[0].rows;
        const data = [];
        const reagent = document.getElementById("ReagentsBase").value;

        for (let i = 0; i < rows.length; i++) {
            console.log(rows[i].cells[0].textContent)
            const temp = parseInt(rows[i].cells[0].textContent, 10); // Temperature input
            const inputs = rows[i].getElementsByTagName("input");
            const ph = parseFloat(inputs[0].value); // PH input
            data.push([temp, ph]);
        }

        // Update the pHData object for the selected reagent
        pHData[reagent] = data;

        // Optional: Logging to console to see the updated pHData object
        console.log('Updated pHData:', pHData);
        document.getElementById("saveTableBtn").classList.add("disabled")
    }

    function updatePhCalTable() {
        // Dynamically add PH calibration points to table
        const table = document.getElementById('phCalTableBody');
        table.innerHTML = '';
        let index = 0
        Object.entries(phCalPoints).forEach(entry => {
            console.log(entry)
            const row = table.insertRow(-1);
            // Reagent
            const reagentCell = row.insertCell(0);
            reagentCell.textContent = entry[0];
            reagentCell.style = "padding: 5px;"

            // PH
            const phCell = row.insertCell(1);
            phCell.textContent = entry[1]["ph"];
            phCell.style = "padding: 5px;"

            // PH ADC
            const phAdcCell = row.insertCell(2);
            phAdcCell.textContent = entry[1]["adc"];
            phAdcCell.style = "padding: 5px;"
            //PH temp
            const phTempCell = row.insertCell(3);
            phTempCell.textContent = entry[1]["temp"];
            phTempCell.style = "padding: 5px;"
            const phDelCell = row.insertCell(4);
            phDelCell.style = "padding: 5px;"
            const deleteButton = document.createElement('button');
            deleteButton.textContent = 'Del';
            deleteButton.onclick = function () {
                deletePhPoint(entry[0]);
            }
            phDelCell.appendChild(deleteButton);
            index = index + 1

        });

    }

    function deletePhPoint(key) {
        delete phCalPoints[key]
        console.log(phCalPoints)
        updatePhCalTable()
        updatePHChart()
    }

    function updatePHChart() {
        console.log("Update PH chart");
        console.log(phCalPoints)
        // Transform the object into an array of objects suitable for the chart
        const calibrationPoints = Object.values(phCalPoints).map(point => ({
            x: point.adc,
            y: point.ph,
        }));

        let interpolatedPoints = []
        console.log("points for interpolatin:", ph_chart_points)
        if (ph_chart_points["PhChartPoints"]) {
            interpolatedPoints = ph_chart_points.PhPoints.map((ph, index) => ({
                x: ph_chart_points.AdcPoints[index],
                y: ph
            }));
        }

        //console.log("---",interpolatedPoints)

        const ctx = document.getElementById('calibrationChart').getContext('2d');
        if (window.myChart) window.myChart.destroy(); // Destroy the existing chart before creating a new one
        window.myChart = new Chart(ctx, {
            type: 'scatter',
            data: {
                datasets: [{
                    label: `Calibration Points for PH`,
                    data: calibrationPoints,
                    backgroundColor: 'rgba(255, 99, 132, 1)'
                }, {
                    label: `Interpolated Curve for PH`,
                    // Assuming ph_chart_points is defined elsewhere correctly
                    data: interpolatedPoints,
                    backgroundColor: 'rgba(54, 162, 235, 1)',
                    showLine: true,
                    fill: false
                }]
            },
            options: {
                scales: {
                    x: {
                        title: {
                            display: true,
                            text: 'ADC Value Volt'
                        }
                    },
                    y: {
                        title: {
                            display: true,
                            text: 'PH@25C'
                        }
                    }
                }
            }
        });
    }

    function uploadPHCalibtaionPoints() {
        const url = window.location.href + '-upload-points';
        console.log("upload data", phCalPoints)

        fetch(url, {
            method: 'POST', // or 'PUT'
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify(phCalPoints),
        })
            .then(response => {
                console.log("Response:", response)
            })
            .then(data => {
                console.log('Success:', data);
            })
            .catch((error) => {
                console.error('Error:', error);
            });
    }

    function addCalPoint() {
        const reagent = document.getElementById("calibrationReagents").value
        console.log("add calibtaion point for ", reagent)

        phCalPoints[reagent] = {"ph": pHData[reagent][3][1], "adc": sse_ph_adc, "temp": sse_temp}
        updatePhCalTable()
        updatePHChart()
    }

    function checkCalReagent() {
        const reagent = document.getElementById("calibrationReagents").value
        if (reagent in phCalPoints) {
            console.log("Cal point already exist")
            document.getElementById("addCalBtn").classList.add("disabled")
        } else {
            document.getElementById("addCalBtn").classList.remove("disabled")
        }
    }

    function getCookie(name) {
        let cookieValue = null;
        console.log("Parsing cookie ", name)
        if (document.cookie && document.cookie !== '') {
            const cookies = document.cookie.split(';');
            for (let i = 0; i < cookies.length; i++) {
                const cookie = cookies[i].trim();
                if (cookie.substring(0, name.length + 1) === (name + '=')) {
                    cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                    break;
                }
            }
        }
        return cookieValue;
    }

    // Cookie event
    document.addEventListener('DOMContentLoaded', function () {
        console.log("Cookie update event")
        const color = getCookie("color")
        const theme = getCookie("theme")
        switchTheme(theme)
        switchColor(color)
        phCalPoints = JSON.parse(getCookie('phCalPoints'));
        console.log("Got calibration points:", phCalPoints)

        const selectReagentBase = document.getElementById("ReagentsBase");
        const selectCalibration = document.getElementById("calibrationReagents");
        Object.entries(pHData).forEach(entry => {
            //console.log(`key: ${entry[0]}`);
            const option = new Option(entry[0], entry[0]);
            selectReagentBase.appendChild(option);
            selectCalibration.appendChild(option);
        })

        // Dynamically add PH calibration points to table
        updatePhCalTable()
        updatePHChart()
        updateTable()
        checkCalReagent()

        // Load extension
        var navbar = document.getElementById('navbarColor01');
        const navbarExtension = JSON.parse(getCookie('Extension'));
        console.log("Extension:", navbarExtension)
        navbarExtension.forEach(addon => {
            console.log("Add ", addon)
            var newNavItem = document.createElement('li');
            newNavItem.className = 'nav-item';

            // Create the link within the list item
            var navLink = document.createElement('a');
            navLink.className = 'nav-link';
            navLink.href = addon["link"];  // Link URL
            navLink.textContent = addon["name"];  // Link text

            // Append the link to the list item, and the list item to the navbar
            newNavItem.appendChild(navLink);
            navbar.querySelector('.navbar-nav').appendChild(newNavItem);
        });

    });

</script>
</body>
</html>
